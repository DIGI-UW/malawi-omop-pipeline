# Integrating with OHDSI

This SQLMesh project creates schemas _similar to_ and _compatible with_ OHDSI OMOP v5.4,
but which do no strictly conform to the schema. The main reason for this has to do with
database systems. The OHDSI community publishes DDL schemas for several databases, but
does not support MySQL.[^1] To keep things simple, this project simply converts data from
a MySQL schema to another MySQL schema.[^2]

There are a couple of ways to transfer data generated from this tool to a PostgreSQL
database:

1. The related [OpenMRS OMOP ETL tooling](https://github.com/openmrs/openmrs-contrib-omop-etl)
   project uses the [PGLoader](https://pgloader.io/) tool to migrate the generated MySQL
   tables into PostgreSQL.
2. There is a project compatible with SQLMesh called [DLT](https://dlthub.com/docs/intro)
   that can load data from diverse sources into SQL stores, including MySQL -> PostgreSQL.
3. [OpenFN](https://docs.openfn.org/) also has adaptors that can load data from MySQL ->
   PostgreSQL.

## Caveats

There is one important place where the data generated by these models break OHDSI is
by using `bigint`s for identifier fields instead of `integers`. This is because the
identifier fields attempt to preserve the full fidelity of the unique identifier for
each row (i.e., site_code + nonce + row_id) which for large tables winds up exceeding
the maximum value of SQL integer (2,147,483,647). These values do fit inside a SQL
big integer (9,223,372,036,854,775,807), which is supported by all database types and
should be safe to use with OHDSI tooling.[^3]

## OpenMRS OMOP ETL

The OpenMRS community has a project for getting OpenMRS data into OMOP format, called
the [OpenMRS OMOP ETL pipeline](https://github.com/openmrs/openmrs-contrib-omop-etl).
This tooling is built on the same foundation as this OMOP Pipeline, translating OpenMRS
data into OMOP schemas in MySQL using SQLMesh. However, it provides slightly different
capabilities that this pipeline. Most notably, it provides support for loading the
finalized data into a PostgreSQL database and connecting this to OHDSI tooling,
especially [Achilles](https://ohdsi.github.io/Achilles/) and related packages, which
this project could benefit from.

Additionally, it provides tooling to aide in mapping more concept-oriented domains,
such as mapping from the OpenMRS `obs` table to the OHDSI `OBSERVATIONS`, `MEASUREMENTS`,
and `NOTES` domains. Here the OpenMRS work has a slightly different philosophy from
this project. This project aims to use OHDSI "standard" codes wherever possible, as
these codes are more broadly useful with OHDSI tooling, but may not always easily
align with codes in OpenMRS systems. The OpenMRS OMOP ETL project tries to map concepts
primarily through the CIEL concept source, which is widely-used in the OpenMRS
community. However, as part of this, it does provide rich tooling to allow mapping
between OpenMRS-formatted codes and OHDSI vocabulary terms, so with some modifications,
this should be workable.

It's also possible to use these domains as a model for how to map some domains from
OHDL to OMOP.

### Caveats about OpenMRS Data Model

While OHDL uses a version of the OpenMRS Data Model, it has somewhat split from the
OpenMRS Data Model and both have evolved slightly differently. Primarily, this is
noticeable in domains that exist in the current OpenMRS Data Model that do not exist
or are represented by obs in the version of the data model used by OHDL. This includes
domains like: visits, diagnoses and conditions that exist in the OpenMRS side but
not OHDL, but also things like the pharmacy_* tables or regimens which exist in
OHDL but are not parts of the OpenMRS Data Model. This does mean that Malawi's OHDL
data will likely always need at least some custom mappings to OMOP to correctly
capture all data.

[^1]: The best _technical_ explanation of this I could find is [this post](https://forums.ohdsi.org/t/sqlrender-with-mysql/476/2),
which is true of MySQL 5.6, but not MySQL 8. In any case, this is currently a limitation
of the [SqlRender](https://github.com/OHDSI/SqlRender) R package that is key to most
OHDSI analysis projects which does not suport MySQL 8.

[^2]: This is also how the underlying SQLMesh library works, i.e., it is a data-transformation
tool, but not a data-loading tool.

[^3]: See forum posts like [this](https://forums.ohdsi.org/t/im-customizing-v5-4-person-id-field-integer-to-bigint-will-i-have-any-problem-running-achilles/23027/3),
[this one](https://forums.ohdsi.org/t/support-for-bigint-64bit-integers-and-r/12858/3
and others. Note that identifiers generated using the scheme we use should be safe
up to 53-bits (9,007,199,254,740,991), which is the "maximum safe integer" value
for many programming languages. This is regarded as the "maximum safe integer" because
it is the largest value that can be converted into an IEEE 754 double-precision float.
